<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å…šå»ºå­¦ä¹ ç³»ç»Ÿ - AIèµ‹èƒ½ç‰ˆ</title>
    <!-- å¼•å…¥ Bootstrap 5 æ ·å¼ -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Vue 3 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft YaHei", sans-serif; }
        .header { background: linear-gradient(135deg, #ce1126 0%, #a30e1d 100%); color: white; padding: 40px 0; margin-bottom: 30px; box-shadow: 0 4px 10px rgba(206, 17, 38, 0.3); }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .ppt-text-box { background-color: #f8f9fa; border-left: 4px solid #ce1126; padding: 15px; font-size: 0.9rem; color: #555; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
        .ai-script-box { font-size: 1.05rem; line-height: 1.8; color: #333; }
        .qa-section { background-color: #eef7fa; border-radius: 8px; padding: 15px; margin-top: 20px; border: 1px solid #bfe2e9; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn-upload { background-color: #ce1126; border-color: #ce1126; padding: 10px 30px; font-size: 1.1rem; }
        .btn-upload:hover { background-color: #a30e1d; border-color: #a30e1d; }
    </style>
</head>
<body>
    <div id="app">
        <!-- å¤´éƒ¨ -->
        <div class="header text-center">
            <h1 class="fw-bold">â˜­ æ™ºæ…§å…šå»ºç†è®ºå­¦ä¹ ç³»ç»Ÿ</h1>
            <p class="lead mt-2">AI é©±åŠ¨ Â· RAG æƒå¨çŸ¥è¯†æ£€ç´¢ Â· æ™ºèƒ½è¯­éŸ³è®²å¸ˆ</p>
        </div>

        <div class="container">
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="row justify-content-center mb-5">
                <div class="col-md-8">
                    <div class="card p-5 shadow-sm">
                        <h3 class="mb-4 text-center text-secondary">ğŸ“„ ä¸Šä¼ å­¦ä¹ ææ–™ (PPT)</h3>
                        <div class="input-group mb-3 input-group-lg">
                            <input type="file" class="form-control" ref="fileInput" accept=".pptx">
                            <button class="btn btn-upload text-white" type="button" @click="uploadPPT" :disabled="loading">
                                {{ loading ? 'æ­£åœ¨è§£æä¸­...' : 'å¼€å§‹ AI è§£æ' }}
                            </button>
                        </div>
                        <div class="text-center text-muted small">
                            æ”¯æŒ .pptx æ ¼å¼ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æå–æ ¸å¿ƒè§‚ç‚¹ã€æ£€ç´¢æƒå¨æ”¿ç­–åº“ï¼Œå¹¶ç”Ÿæˆè¯­éŸ³è®²è§£ã€‚
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
            <div v-if="results.length > 0" class="row animate__animated animate__fadeIn">
                <div class="col-12 mb-4">
                    <h3 class="border-bottom pb-2 border-danger text-danger">ğŸ“š è§£æç»“æœä¸æ™ºèƒ½å¯¼å­¦</h3>
                </div>
                
                <div class="col-md-12" v-for="(item, index) in results" :key="index">
                    <div class="card p-4">
                        <div class="row g-4">
                            <!-- å·¦ä¾§ï¼šPPTåŸå§‹å†…å®¹ -->
                            <div class="col-md-4">
                                <h5 class="text-danger fw-bold mb-3">
                                    <span class="badge bg-danger">ç¬¬ {{ item.page }} é¡µ</span> åŸæ–‡æå–
                                </h5>
                                <div class="ppt-text-box">
                                    {{ item.ppt_text }}
                                </div>
                            </div>
                            
                            <!-- å³ä¾§ï¼šAI ç”Ÿæˆçš„è®²è§£ä¸äº’åŠ¨ -->
                            <div class="col-md-8">
                                <h5 class="text-primary fw-bold mb-3">
                                    ğŸ¤– AI è®²å¸ˆè§£è¯» <small class="text-muted fw-normal">(åŸºäºæƒå¨çŸ¥è¯†åº“ RAG)</small>
                                </h5>
                                
                                <!-- è®²è§£è¯ -->
                                <div class="ai-script-box">
                                    {{ item.ai_script }}
                                </div>

                                <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
                                <div class="mt-3 bg-light p-3 rounded d-flex align-items-center border">
                                    <span class="badge bg-success me-3">è¯­éŸ³æ’­æŠ¥</span>
                                    <audio controls :src="item.audio_url" style="width: 100%; height: 36px;"></audio>
                                </div>

                                <!-- ======= æ–°å¢ï¼šæ™ºèƒ½é—®ç­”äº¤äº’åŒº ======= -->
                                <div class="qa-section">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="text-info m-0 fw-bold">ğŸ™‹â€â™‚ï¸ äº’åŠ¨é—®ç­”åŠ©æ‰‹</h6>
                                        <small class="ms-2 text-muted">å¯¹æœ¬é¡µå†…å®¹æœ‰ç–‘é—®ï¼ŸAI åŠ©æ•™ä¸ºæ‚¨å®æ—¶è§£ç­”ã€‚</small>
                                    </div>
                                    
                                    <!-- æé—®è¾“å…¥æ¡† -->
                                    <div class="input-group">
                                        <input type="text" class="form-control" 
                                               placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š'è¿™æ®µæåˆ°çš„æ–°è´¨ç”Ÿäº§åŠ›æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ'" 
                                               v-model="item.userQuestion" 
                                               @keyup.enter="askAI(item)">
                                        <button class="btn btn-info text-white" type="button" 
                                                @click="askAI(item)" 
                                                :disabled="item.asking">
                                            {{ item.asking ? 'æ€è€ƒä¸­...' : 'æé—®' }}
                                        </button>
                                    </div>

                                    <!-- AI å›ç­”å±•ç¤º -->
                                    <div v-if="item.aiAnswer" class="mt-3 p-3 bg-white border rounded shadow-sm" style="border-left: 5px solid #0dcaf0;">
                                        <div class="d-flex mb-1">
                                            <strong>ğŸ§  åŠ©æ•™å›ç­”ï¼š</strong>
                                        </div>
                                        <p class="mb-0 text-dark" style="font-size: 0.95rem; white-space: pre-wrap;">{{ item.aiAnswer }}</p>
                                    </div>
                                </div>
                                <!-- ================================== -->

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading é®ç½©å±‚ -->
        <div v-if="loading" class="loading-overlay">
            <div class="spinner-grow text-danger" style="width: 4rem; height: 4rem;" role="status"></div>
            <h3 class="mt-4 text-danger fw-bold">ç³»ç»Ÿæ­£åœ¨å…¨é€Ÿè¿è½¬...</h3>
            <p class="text-muted fs-5">æ­£åœ¨è¿›è¡Œ RAG çŸ¥è¯†åº“æ£€ç´¢ Â· è®²ç¨¿ç”Ÿæˆ Â· è¯­éŸ³åˆæˆ</p>
            <p class="small text-secondary">(é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å‡ åç§’æ„å»ºç´¢å¼•ï¼Œè¯·è€å¿ƒç­‰å¾…)</p>
        </div>
    </div>

    <script>
        const { createApp, ref } = Vue;

        createApp({
            setup() {
                const loading = ref(false);
                const results = ref([]);
                const fileInput = ref(null);

                // ä¸Šä¼  PPT çš„é€»è¾‘
                const uploadPPT = async () => {
                    const file = fileInput.value.files[0];
                    if (!file) {
                        alert("âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ª PPT æ–‡ä»¶ï¼");
                        return;
                    }

                    loading.value = true;
                    results.value = []; // æ¸…ç©ºä¹‹å‰çš„ç»“æœ

                    const formData = new FormData();
                    formData.append("file", file);

                    try {
                        const response = await fetch("/upload_ppt", {
                            method: "POST",
                            body: formData
                        });

                        const json = await response.json();
                        
                        if (json.status === "success") {
                            // ä¸ºæ¯ä¸€é¡¹æ•°æ®å¢åŠ é—®ç­”ç›¸å…³çš„çŠ¶æ€å˜é‡
                            results.value = json.data.map(item => ({
                                ...item,
                                userQuestion: "", // ç”¨æˆ·è¾“å…¥çš„é—®é¢˜
                                aiAnswer: null,   // AI çš„å›ç­”
                                asking: false     // æ˜¯å¦æ­£åœ¨æé—®ä¸­
                            }));
                        } else {
                            alert("âŒ è§£æå¤±è´¥ï¼š" + json.message);
                        }
                    } catch (error) {
                        console.error(error);
                        alert("âŒ ç½‘ç»œè¯·æ±‚å‡ºé”™ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ã€‚");
                    } finally {
                        loading.value = false;
                    }
                };

                // æ™ºèƒ½é—®ç­”çš„é€»è¾‘
                const askAI = async (item) => {
                    if (!item.userQuestion || item.userQuestion.trim() === "") {
                        alert("è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼");
                        return;
                    }

                    item.asking = true;
                    item.aiAnswer = null; // æ¸…ç©ºæ—§å›ç­”

                    try {
                        const res = await fetch("/ask_ai", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                question: item.userQuestion,
                                ppt_context: item.ppt_text // æŠŠå½“å‰PPTé¡µå†…å®¹ä¼ è¿‡å»ä½œä¸ºä¸Šä¸‹æ–‡
                            })
                        });
                        const json = await res.json();
                        if (json.status === "success") {
                            item.aiAnswer = json.answer;
                        } else {
                            alert("å›ç­”å¤±è´¥ï¼š" + json.message);
                        }
                    } catch (e) {
                        alert("ç½‘ç»œè¯·æ±‚å¤±è´¥");
                    } finally {
                        item.asking = false;
                    }
                };

                return {
                    loading,
                    results,
                    fileInput,
                    uploadPPT,
                    askAI
                };
            }
        }).mount('#app');
    </script>
</body>
</html>